function initMarkers(){searchUrl+="?ajax=1&all=1",downloadUrl(searchUrl,function(e){for(var t=parseXml(e),o=t.documentElement.getElementsByTagName("marker"),a=new google.maps.LatLngBounds,n=0;n<o.length;n++){var r=o[n].getAttribute("name"),s=o[n].getAttribute("address"),i=(o[n].getAttribute("addressNoHtml"),o[n].getAttribute("other")),l=o[n].getAttribute("id_store"),c=o[n].getAttribute("has_store_picture"),d=new google.maps.LatLng(parseFloat(o[n].getAttribute("lat")),parseFloat(o[n].getAttribute("lng")));createMarker(d,r,s,i,l,c),a.extend(d)}map.fitBounds(a);var g=map.getZoom();g>10&&(g=10),map.setZoom(g)})}function searchLocations(){$("#stores_loader").show();var e=document.getElementById("addressInput").value,t=new google.maps.Geocoder;t.geocode({address:e},function(t,o){o===google.maps.GeocoderStatus.OK?searchLocationsNear(t[0].geometry.location):$.prototype.fancybox&&isCleanHtml(e)?$.fancybox.open([{type:"inline",autoScale:!0,minHeight:30,content:'<p class="fancybox-error">'+e+" "+translation_6+"</p>"}],{padding:0}):alert(e+" "+translation_6),$("#stores_loader").hide()})}function clearLocations(e){infoWindow.close();for(var t=0;t<markers.length;t++)markers[t].setMap(null);markers.length=0,locationSelect.innerHTML="";var o=document.createElement("option");o.value="none",o.innerHTML=e?1===e?"1 "+translation_2:e+" "+translation_3:translation_1,locationSelect.appendChild(o),$.prototype.uniform&&$("select#locationSelect").uniform(),$("#stores-table tr.node").remove()}function searchLocationsNear(e){var t=document.getElementById("radiusSelect").value,o=baseUri+"?controller=stores&ajax=1&latitude="+e.lat()+"&longitude="+e.lng()+"&radius="+t;downloadUrl(o,function(e){var t=parseXml(e),o=t.documentElement.getElementsByTagName("marker"),a=new google.maps.LatLngBounds;clearLocations(o.length),$("table#stores-table").find("tbody tr").remove();for(var n=0;n<o.length;n++){var r=o[n].getAttribute("name"),s=o[n].getAttribute("address"),i=(o[n].getAttribute("addressNoHtml"),o[n].getAttribute("other")),l=parseFloat(o[n].getAttribute("distance")),c=parseFloat(o[n].getAttribute("id_store")),d=o[n].getAttribute("phone"),g=o[n].getAttribute("has_store_picture"),p=new google.maps.LatLng(parseFloat(o[n].getAttribute("lat")),parseFloat(o[n].getAttribute("lng")));createOption(r,l,n),createMarker(p,r,s,i,c,g),a.extend(p),s=s.replace(d,""),$("table#stores-table").find("tbody").append('<tr ><td class="num">'+parseInt(n+1)+'</td><td class="name">'+(1==g?'<img src="'+img_store_dir+parseInt(c)+'.jpg" alt="" />':"")+"<span>"+r+'</span></td><td class="address">'+s+(""!==d?""+translation_4+" "+d:"")+'</td><td class="distance">'+l+" "+distance_unit+"</td></tr>"),$("#stores-table").show()}if(o.length){map.fitBounds(a);var m=google.maps.event.addListener(map,"idle",function(){map.getZoom()>13&&map.setZoom(13),google.maps.event.removeListener(m)})}locationSelect.style.visibility="visible",$(locationSelect).parent().parent().addClass("active").show(),locationSelect.onchange=function(){var e=locationSelect.options[locationSelect.selectedIndex].value;google.maps.event.trigger(markers[e],"click")}})}function createMarker(e,t,o,a,n,r){var s="<b>"+t+"</b><br/>"+o+(1===r?'<br /><br /><img src="'+img_store_dir+parseInt(n)+'.jpg" alt="" />':"")+a+'<br /><a href="http://maps.google.com/maps?saddr=&daddr='+e+'" target="_blank">'+translation_5+"</a>",i=new google.maps.MarkerImage(img_ps_dir+logo_store),l="";l=hasStoreIcon?new google.maps.Marker({map:map,icon:i,position:e}):new google.maps.Marker({map:map,position:e}),google.maps.event.addListener(l,"click",function(){infoWindow.setContent(s),infoWindow.open(map,l)}),markers.push(l)}function createOption(e,t,o){var a=document.createElement("option");a.value=o,a.innerHTML=e+" ("+t.toFixed(1)+" "+distance_unit+")",locationSelect.appendChild(a)}function downloadUrl(e,t){var o=window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;o.onreadystatechange=function(){4===o.readyState&&(o.onreadystatechange=doNothing,t(o.responseText,o.status))},o.open("GET",e,!0),o.send(null)}function parseXml(e){if(window.ActiveXObject){var t=new ActiveXObject("Microsoft.XMLDOM");return t.loadXML(e),t}return window.DOMParser?(new DOMParser).parseFromString(e,"text/xml"):void 0}function doNothing(){}$(document).ready(function(){map=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(defaultLat,defaultLong),zoom:10,mapTypeId:"roadmap",mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.DROPDOWN_MENU}}),infoWindow=new google.maps.InfoWindow,locationSelect=document.getElementById("locationSelect"),locationSelect.onchange=function(){var e=locationSelect.options[locationSelect.selectedIndex].value;"none"!==e&&google.maps.event.trigger(markers[e],"click")},$("#addressInput").keypress(function(e){code=e.keyCode?e.keyCode:e.which,13===code.toString()&&searchLocations()}),$(document).on("click","input[name=location]",function(e){e.preventDefault(),$(this).val("")}),$(document).on("click","button[name=search_locations]",function(e){e.preventDefault(),searchLocations()}),initMarkers()});